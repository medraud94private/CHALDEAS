# GPU Thermal Management for Book Extractor

## ê°œìš”

Book Extractorê°€ ì¥ì‹œê°„ GPUë¥¼ ì‚¬ìš©í•  ë•Œ ì˜¨ë„ ê´€ë¦¬ë¥¼ í†µí•´ í•˜ë“œì›¨ì–´ ë³´í˜¸ ë° ì•ˆì •ì ì¸ ì‘ì—… ìˆ˜í–‰ì„ ë³´ì¥í•˜ëŠ” ê¸°ëŠ¥.

## í˜„ì¬ ìƒí™©

- **GPU**: NVIDIA GeForce RTX 3060 Laptop GPU (6GB VRAM)
- **ì‘ì—…**: Ollama llama3.1:8b ëª¨ë¸ë¡œ ì±… ì—”í‹°í‹° ì¶”ì¶œ
- **ê´€ì¸¡ ì˜¨ë„**: 85-86ë„ (GPU 96-97% ì‚¬ìš© ì‹œ)
- **ì˜ˆìƒ ì‘ì—… ì‹œê°„**: 247ê¶Œ Ã— 9ë¶„/ê¶Œ = ì•½ 37ì‹œê°„

---

## êµ¬í˜„ ì™„ë£Œ: ì†ë„ ëª¨ë“œ ì‹œìŠ¤í…œ

### ì†ë„ ëª¨ë“œ ì„¤ì •

í”„ë¡ íŠ¸ì—”ë“œ UIì—ì„œ ì‹¤ì‹œê°„ ì „í™˜ ê°€ëŠ¥ (http://localhost:8200)

| ëª¨ë“œ | GPU ë ˆì´ì–´ | ë”œë ˆì´ | ì˜ˆìƒ ì†ë„ | í° ì±…(300KB) | íŒ¬ ì†ŒìŒ |
|------|-----------|--------|----------|-------------|--------|
| **high** | 99 (ì „ì²´) | 0.1ì´ˆ | ~25 tok/s | ~25ë¶„ | ì‹œë„ëŸ¬ì›€ |
| **medium** | 20 | 1.0ì´ˆ | ~15 tok/s | ~40ë¶„ | ë³´í†µ |
| **low** | 10 | 2.0ì´ˆ | ~10 tok/s | ~60ë¶„ | ì¡°ìš©í•¨ |
| **quiet** | 0 (CPU) | 3.0ì´ˆ | ~5 tok/s | ~2ì‹œê°„ | ë¬´ìŒ |

### ì „ì²´ ì‘ì—… ì˜ˆìƒ ì‹œê°„ (198ê¶Œ ê¸°ì¤€)

| ëª¨ë“œ | ì˜ˆìƒ ì†Œìš” ì‹œê°„ |
|------|---------------|
| high | ~4ì¼ |
| medium | ~6ì¼ |
| low | ~10ì¼ |
| quiet | ~16-20ì¼ |

### ì‹¤ì¸¡ ë°ì´í„° (2026-01-22)

**High ëª¨ë“œ ì‹œê°„ëŒ€ë³„ ì²˜ë¦¬ëŸ‰**:

| ì‹œê°„ëŒ€ | ì™„ì„± ìˆ˜ | ë¹„ê³  |
|--------|---------|------|
| 15:00 | 5ê¶Œ | ë¹ ë¦„ |
| 16:00-18:00 | 3-4ê¶Œ/ì‹œê°„ | í‰ê·  |
| 19:00 | 1ê¶Œ | ëŒ€í˜• ì±… |
| 20:00-22:00 | 4ê¶Œ/ì‹œê°„ | í‰ê·  |

**ì±… í¬ê¸°ë³„ ì²˜ë¦¬ ì‹œê°„ (High ëª¨ë“œ)**:

| ê²°ê³¼ íŒŒì¼ í¬ê¸° | ì²˜ë¦¬ ì‹œê°„ | ì˜ˆì‹œ |
|---------------|----------|------|
| ~100KB | ~10ë¶„ | ì§§ì€ ì‹œ/ì†Œì„¤ |
| ~200KB | ~20ë¶„ | ì¼ë°˜ ì±… |
| ~300KB | ~25-30ë¶„ | ì¤‘í˜• ì±… |
| ~400KB+ | ~40-50ë¶„ | Plutarch, Ovid ë“± ëŒ€ì‘ |
| ~550KB | ~50ë¶„+ | Plutarch's Lives |

### API ì—”ë“œí¬ì¸íŠ¸

```
GET  /api/speed          # í˜„ì¬ ì†ë„ ëª¨ë“œ ì¡°íšŒ
POST /api/speed/{mode}   # ì†ë„ ëª¨ë“œ ë³€ê²½ (high/medium/low/quiet)
```

**ì‘ë‹µ ì˜ˆì‹œ**:
```json
{
  "mode": "high",
  "chunk_delay": 0.1,
  "num_gpu": 99,
  "num_ctx": 4096,
  "description": "High (full GPU)"
}
```

### ì„œë²„ êµ¬í˜„ (`server.py`)

```python
SPEED_MODES = {
    "high": {"chunk_delay": 0.1, "num_gpu": 99, "num_ctx": 4096, "description": "High (full GPU)"},
    "medium": {"chunk_delay": 1.0, "num_gpu": 20, "num_ctx": 4096, "description": "Medium (20 layers)"},
    "low": {"chunk_delay": 2.0, "num_gpu": 10, "num_ctx": 4096, "description": "Low (10 layers)"},
    "quiet": {"chunk_delay": 3.0, "num_gpu": 0, "num_ctx": 4096, "description": "Quiet (CPU only)"},
}
```

### í”„ë¡ íŠ¸ì—”ë“œ UI

ì†ë„ ì¡°ì ˆ ë²„íŠ¼ (ìš°ì¸¡ ìƒë‹¨):
- ğŸ”‡ Quiet (CPU only)
- ğŸ¢ Low (10 layers)
- ğŸš¶ Medium (20 layers)
- ğŸš€ High (full GPU)

### ê¶Œì¥ ì‚¬ìš© ì‹œë‚˜ë¦¬ì˜¤

| ìƒí™© | ê¶Œì¥ ëª¨ë“œ |
|------|----------|
| ë¹ ë¥¸ ì²˜ë¦¬ í•„ìš”, ì†ŒìŒ ë¬´ê´€ | high |
| ì¼ë°˜ ì‘ì—…, ì ë‹¹í•œ ì†ŒìŒ | medium |
| ì•¼ê°„ ì‘ì—…, ì¡°ìš©íˆ | low |
| ì·¨ì¹¨ ì‹œê°„, ì™„ì „ ë¬´ìŒ | quiet |

---

## RTX 3060 Laptop GPU ì˜¨ë„ ê¸°ì¤€

| ì˜¨ë„ ë²”ìœ„ | ìƒíƒœ | ì„¤ëª… |
|-----------|------|------|
| ~60ë„ | Idle | ìœ íœ´ ìƒíƒœ |
| 60-70ë„ | ì •ìƒ | ê°€ë²¼ìš´ ì‘ì—… |
| 70-80ë„ | ì–‘í˜¸ | ì¼ë°˜ì ì¸ ê³ ë¶€í•˜ |
| 80-87ë„ | ë†’ìŒ | ì¥ì‹œê°„ ì‹œ ì£¼ì˜ í•„ìš” |
| 87-92ë„ | ì“°ë¡œí‹€ë§ | GPUê°€ ìë™ìœ¼ë¡œ ì„±ëŠ¥ ì œí•œ |
| 92ë„+ | ìœ„í—˜ | ì‹œìŠ¤í…œ ë³´í˜¸ë¥¼ ìœ„í•œ ì…§ë‹¤ìš´ ê°€ëŠ¥ |

## êµ¬í˜„ ë°©ì•ˆ

### ì˜µì…˜ A: ë‹¨ìˆœ ì„ê³„ê°’ ê¸°ë°˜ (Simple Threshold)

```
ë§¤ 60ì´ˆë§ˆë‹¤ ì˜¨ë„ ì²´í¬:
- 90ë„ ì´ìƒ â†’ ì¦‰ì‹œ ì¼ì‹œì •ì§€
- 70ë„ ì´í•˜ â†’ ì¬ê°œ
```

**ì¥ì **: êµ¬í˜„ ê°„ë‹¨
**ë‹¨ì **: ë¹ˆë²ˆí•œ on/offë¡œ ë¹„íš¨ìœ¨ì 

### ì˜µì…˜ B: ë™ì  ë”œë ˆì´ ì¡°ì ˆ (Dynamic Throttling) - ê¶Œì¥

ì˜¨ë„ì— ë”°ë¼ ì²­í¬ ì‚¬ì´ ë”œë ˆì´ë¥¼ ë™ì ìœ¼ë¡œ ì¡°ì ˆ:

| ì˜¨ë„ | ë”œë ˆì´ | ì„¤ëª… |
|------|--------|------|
| ~70ë„ | 0.1ì´ˆ | ìµœëŒ€ ì†ë„ |
| 75ë„ | 0.3ì´ˆ | ì•½ê°„ ê°ì† |
| 80ë„ | 0.5ì´ˆ | ì¤‘ê°„ ê°ì† |
| 85ë„ | 1.0ì´ˆ | ìƒë‹¹íˆ ê°ì† |
| 88ë„ | 2.0ì´ˆ | í¬ê²Œ ê°ì† |
| 90ë„+ | ì¼ì‹œì •ì§€ | 70ë„ ì´í•˜ê¹Œì§€ ëŒ€ê¸° |

**ì¥ì **: ë¶€ë“œëŸ¬ìš´ ì¡°ì ˆ, íš¨ìœ¨ì 
**ë‹¨ì **: êµ¬í˜„ ë³µì¡ë„ ì•½ê°„ ì¦ê°€

### ì˜µì…˜ C: ì‹œê°„ ê¸°ë°˜ íœ´ì‹ (Time-based Rest)

```
80ë„ ì´ìƒ ì—°ì† 3ì‹œê°„ â†’ 30ë¶„ ê°•ì œ íœ´ì‹
85ë„ ì´ìƒ ì—°ì† 1ì‹œê°„ â†’ 15ë¶„ ê°•ì œ íœ´ì‹
```

**ì¥ì **: ì¥ì‹œê°„ ì‘ì—…ì— ì í•©, í•˜ë“œì›¨ì–´ ë³´í˜¸
**ë‹¨ì **: ì‘ì—… ì¤‘ë‹¨ ë°œìƒ

### ê¶Œì¥: ì˜µì…˜ B + C ì¡°í•©

1. ê¸°ë³¸ì ìœ¼ë¡œ ë™ì  ë”œë ˆì´ ì¡°ì ˆ (ì˜µì…˜ B)
2. ì¶”ê°€ë¡œ ì‹œê°„ ê¸°ë°˜ íœ´ì‹ (ì˜µì…˜ C)
3. ë¹„ìƒ ì‹œ ì¦‰ì‹œ ì •ì§€ (90ë„ ì´ìƒ)

## ê¸°ìˆ  êµ¬í˜„

### ì˜¨ë„ ì²´í¬ ë°©ë²•

```python
import subprocess

def get_gpu_temperature() -> int:
    """nvidia-smië¡œ GPU ì˜¨ë„ ì¡°íšŒ"""
    result = subprocess.run(
        ['nvidia-smi', '--query-gpu=temperature.gpu', '--format=csv,noheader'],
        capture_output=True, text=True
    )
    return int(result.stdout.strip())
```

### ëŒ€ì•ˆ: pynvml ë¼ì´ë¸ŒëŸ¬ë¦¬

```python
import pynvml

def get_gpu_temperature() -> int:
    """pynvmlë¡œ GPU ì˜¨ë„ ì¡°íšŒ (ë” ì•ˆì •ì )"""
    pynvml.nvmlInit()
    handle = pynvml.nvmlDeviceGetHandleByIndex(0)
    temp = pynvml.nvmlDeviceGetTemperature(handle, pynvml.NVML_TEMPERATURE_GPU)
    pynvml.nvmlShutdown()
    return temp
```

### ë™ì  ë”œë ˆì´ ê³„ì‚°

```python
def get_delay_for_temperature(temp: int) -> float:
    """ì˜¨ë„ì— ë”°ë¥¸ ë”œë ˆì´ ê³„ì‚°"""
    if temp >= 90:
        return -1  # ì¼ì‹œì •ì§€ ì‹ í˜¸
    elif temp >= 88:
        return 2.0
    elif temp >= 85:
        return 1.0
    elif temp >= 80:
        return 0.5
    elif temp >= 75:
        return 0.3
    else:
        return 0.1  # ê¸°ë³¸ê°’
```

### ì„œë²„ í†µí•© ìœ„ì¹˜

`tools/book_extractor/server.py`ì˜ `run_extraction()` í•¨ìˆ˜ ë‚´:

```python
# ì²­í¬ ì²˜ë¦¬ ë£¨í”„ ë‚´ë¶€
for i, chunk_info in enumerate(hierarchical_chunks):
    # ... ì²­í¬ ì²˜ë¦¬ ...

    # ì˜¨ë„ ê¸°ë°˜ ë”œë ˆì´ (ë§¤ 10ì²­í¬ë§ˆë‹¤ ì²´í¬)
    if i % 10 == 0:
        temp = get_gpu_temperature()
        delay = get_delay_for_temperature(temp)

        if delay < 0:  # ì¼ì‹œì •ì§€
            print(f"[Thermal] GPU {temp}ë„ - ëƒ‰ê° ëŒ€ê¸° ì¤‘...")
            while get_gpu_temperature() > 70:
                await asyncio.sleep(10)
            print(f"[Thermal] GPU ëƒ‰ê° ì™„ë£Œ - ì¬ê°œ")
        else:
            await asyncio.sleep(delay)
```

## ëª¨ë‹ˆí„°ë§ API

### GET /api/thermal/status

```json
{
  "temperature": 85,
  "delay_current": 1.0,
  "status": "throttled",
  "high_temp_duration_minutes": 45,
  "last_rest_time": "2026-01-21T10:30:00"
}
```

## UI í‘œì‹œ

ì›¹ UIì— ì¶”ê°€í•  ì •ë³´:
- í˜„ì¬ GPU ì˜¨ë„
- í˜„ì¬ ì ìš© ë”œë ˆì´
- ê³ ì˜¨ ì§€ì† ì‹œê°„
- ë‹¤ìŒ ì˜ˆìƒ íœ´ì‹ ì‹œê°„

## ì„¤ì • ì˜µì…˜

```python
THERMAL_CONFIG = {
    "enabled": True,
    "check_interval_chunks": 10,      # ëª‡ ì²­í¬ë§ˆë‹¤ ì˜¨ë„ ì²´í¬
    "thresholds": {
        "normal": 70,      # ì´í•˜ë©´ ìµœëŒ€ ì†ë„
        "warning": 80,     # ê°ì† ì‹œì‘
        "critical": 88,    # í¬ê²Œ ê°ì†
        "emergency": 90,   # ì¼ì‹œì •ì§€
    },
    "cooldown_target": 70,            # ì¼ì‹œì •ì§€ í›„ ì¬ê°œ ì˜¨ë„
    "forced_rest": {
        "enabled": True,
        "high_temp_threshold": 80,
        "duration_hours": 3,
        "rest_minutes": 30,
    }
}
```

## ì˜ˆìƒ íš¨ê³¼

| í•­ëª© | í˜„ì¬ | ì ìš© í›„ |
|------|------|---------|
| GPU ì˜¨ë„ | 85-86ë„ | 75-82ë„ |
| ì±…ë‹¹ ì²˜ë¦¬ ì‹œê°„ | 9ë¶„ | 10-12ë¶„ (ì˜ˆìƒ) |
| í•˜ë“œì›¨ì–´ ì•ˆì •ì„± | ìœ„í—˜ | ì•ˆì „ |
| ì´ ì‘ì—… ì‹œê°„ | 37ì‹œê°„ | 45-50ì‹œê°„ (ì˜ˆìƒ) |

## êµ¬í˜„ ìš°ì„ ìˆœìœ„

1. [ ] ì˜¨ë„ ì²´í¬ í•¨ìˆ˜ ì¶”ê°€
2. [ ] ë™ì  ë”œë ˆì´ ë¡œì§ êµ¬í˜„
3. [ ] ì¼ì‹œì •ì§€/ì¬ê°œ ë¡œì§ êµ¬í˜„
4. [ ] ì‹œê°„ ê¸°ë°˜ ê°•ì œ íœ´ì‹ ì¶”ê°€
5. [ ] API ì—”ë“œí¬ì¸íŠ¸ ì¶”ê°€
6. [ ] UI í‘œì‹œ ì¶”ê°€

## ì°¸ê³ 

- NVIDIA GPU ì˜¨ë„ ê°€ì´ë“œ: https://www.nvidia.com/en-us/geforce/
- RTX 3060 ìŠ¤í™: TDP 115W, Max Temp 93ë„
- pynvml ë¬¸ì„œ: https://pypi.org/project/pynvml/
