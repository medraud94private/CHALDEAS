# CHALDEAS V1 시스템 개요

> 이 문서는 CHALDEAS Historical Chain 시스템의 전체 흐름을 설명합니다.

---

## 1. 완성된 시스템에서 유저 경험

### 1.1 메인 화면

```
┌────────────────────────────────────────────────────────────────────────┐
│                         🌍 CHALDEAS                                    │
│                                                                        │
│  ┌──────────────────────────────────────────────────────────────────┐  │
│  │                                                                  │  │
│  │                      [3D 지구본]                                 │  │
│  │                                                                  │  │
│  │           ● 아테네 (5 events)                                    │  │
│  │                    ● 로마 (12 events)                            │  │
│  │                              ● 피렌체 (8 events)                 │  │
│  │                                                                  │  │
│  └──────────────────────────────────────────────────────────────────┘  │
│                                                                        │
│  ──●────────────────────●────────────────────●──────────────────────   │
│   -500 BCE           0 CE                 1500 CE         [타임라인]   │
│                                                                        │
│  [검색창: "소크라테스에 대해 알려줘"]                                    │
└────────────────────────────────────────────────────────────────────────┘
```

### 1.2 사용 시나리오

#### 시나리오 A: 인물 탐색
```
유저: "소크라테스에 대해 알려줘"

시스템 응답:
┌─────────────────────────────────────────────────────────────────┐
│ 📜 소크라테스의 이야기                                           │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│ #1 탄생과 성장 (-470)                                           │
│ ┌─────────────────────────────────────────────────────────────┐ │
│ │ 소크라테스는 기원전 470년경 아테네에서 태어났습니다.          │ │
│ │ 그의 아버지는 조각가, 어머니는 산파였습니다...                │ │
│ │                                                             │ │
│ │ 📍 아테네  📅 -470  📚 출처: 플라톤의 대화편                  │ │
│ └─────────────────────────────────────────────────────────────┘ │
│                            │                                    │
│                            ▼                                    │
│ #2 철학적 활동 (-450 ~ -400)                                    │
│ ┌─────────────────────────────────────────────────────────────┐ │
│ │ 소크라테스는 아테네 광장(아고라)에서 시민들과 대화를 나누며   │ │
│ │ 진리를 탐구했습니다. "너 자신을 알라"는 그의 핵심 가르침...   │ │
│ │                                                             │ │
│ │ 📍 아고라  📅 -450~-400  📚 출처: 크세노폰의 회상             │ │
│ └─────────────────────────────────────────────────────────────┘ │
│                            │                                    │
│                            ▼                                    │
│ #3 재판과 죽음 (-399)                                           │
│ ┌─────────────────────────────────────────────────────────────┐ │
│ │ 기원전 399년, 소크라테스는 "청년을 타락시키고 국가의 신을     │ │
│ │ 믿지 않는다"는 혐의로 재판에 회부되었습니다. 그는 독배를      │ │
│ │ 마시고 생을 마감했습니다...                                   │ │
│ │                                                             │ │
│ │ 📍 아테네  📅 -399  📚 출처: 플라톤의 '소크라테스의 변명'     │ │
│ └─────────────────────────────────────────────────────────────┘ │
│                                                                 │
│ 🔗 관련 인물: 플라톤, 크세노폰, 아리스토텔레스                    │
│ 🗺️ 관련 장소: 아테네, 아고라, 델포이                             │
│ 📖 관련 시대: 고전 그리스 (-500 ~ -323)                          │
└─────────────────────────────────────────────────────────────────┘
```

#### 시나리오 B: 시대 탐색
```
유저: "르네상스 시대를 보여줘"

시스템 응답:
┌─────────────────────────────────────────────────────────────────┐
│ 🏛️ 르네상스 시대 (1400-1600)                                    │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│ 📊 개요                                                         │
│ ├── 기간: 1400년 ~ 1600년 (200년)                               │
│ ├── 중심지: 이탈리아 (피렌체, 로마, 베네치아)                    │
│ ├── 특징: 고전 문화의 부흥, 인문주의, 예술과 과학의 발전         │
│ └── 시간 스케일: Conjuncture (중기 지속)                         │
│                                                                 │
│ 👤 주요 인물 (32명)                                              │
│ ├── 레오나르도 다 빈치 (1452-1519) - 화가, 발명가                │
│ ├── 미켈란젤로 (1475-1564) - 조각가, 화가                        │
│ ├── 라파엘로 (1483-1520) - 화가                                  │
│ ├── 마키아벨리 (1469-1527) - 정치철학자                          │
│ └── [더 보기...]                                                 │
│                                                                 │
│ 📅 주요 사건 (78개)                                              │
│ ├── 1453: 콘스탄티노플 함락                                      │
│ ├── 1455: 구텐베르크 인쇄술 발명                                 │
│ ├── 1492: 콜럼버스 신대륙 발견                                   │
│ ├── 1503: 모나리자 제작 시작                                     │
│ └── [더 보기...]                                                 │
│                                                                 │
│ 🗺️ [지구본에 르네상스 중심지 하이라이트]                          │
└─────────────────────────────────────────────────────────────────┘
```

#### 시나리오 C: 인과관계 탐색
```
유저: "로마 제국 멸망의 원인은?"

시스템 응답:
┌─────────────────────────────────────────────────────────────────┐
│ 🔗 로마 제국 멸망의 인과 사슬                                    │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│ [경제적 요인]                   [군사적 요인]                    │
│      │                              │                           │
│      ▼                              ▼                           │
│ ┌─────────┐                    ┌─────────┐                      │
│ │ 화폐가치 │                    │ 게르만족│                      │
│ │ 하락    │                    │ 침입    │                      │
│ │ (3세기) │                    │ (4-5세기)│                      │
│ └────┬────┘                    └────┬────┘                      │
│      │                              │                           │
│      └──────────┬───────────────────┘                           │
│                 ▼                                               │
│           ┌───────────┐                                         │
│           │ 서로마 제국│                                         │
│           │ 멸망 (476)│                                         │
│           └───────────┘                                         │
│                                                                 │
│ 📖 각 노드 클릭 시 상세 설명 및 출처 확인 가능                    │
└─────────────────────────────────────────────────────────────────┘
```

### 1.3 핵심 기능 요약

| 기능 | 설명 | 예시 |
|------|------|------|
| **인물 체인** | 한 인물의 생애를 시간순으로 | "다빈치의 생애" |
| **장소 체인** | 한 장소의 역사적 변천 | "로마의 2000년" |
| **시대 체인** | 특정 시대의 주요 사건/인물 | "르네상스 개관" |
| **인과 체인** | 사건 간 원인-결과 관계 | "프랑스 혁명의 원인" |
| **자유 질문** | 자연어로 역사 질문 | "왜 그리스가 페르시아를 이겼어?" |

---

## 2. 새로운 책 추가 시 처리 과정

### 2.1 전체 흐름

```
┌─────────────────────────────────────────────────────────────────────────┐
│                     새 책 추가 파이프라인                                │
└─────────────────────────────────────────────────────────────────────────┘

[STEP 1] 텍스트 입력
    │
    │  예: "The History of Rome" by Livy
    │  (Gutenberg에서 다운로드)
    │
    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│  TextSource 생성                                                        │
│  {                                                                      │
│    source_type: "gutenberg",                                            │
│    external_id: "PG10828",                                              │
│    title: "The History of Rome, Vol. I",                                │
│    author: "Livy",                                                      │
│    content: "In the first place, it is generally admitted that..."      │
│  }                                                                      │
└─────────────────────────────────────────────────────────────────────────┘
    │
    ▼
[STEP 2] 텍스트 청킹 (2000자 단위)
    │
    │  Chunk 1: "In the first place, it is generally admitted..."
    │  Chunk 2: "Romulus and Remus were born to..."
    │  Chunk 3: ...
    │
    ▼
[STEP 3] NER 추출 (spaCy + Ollama)
    │
    │  ┌────────────────────────────────────────────┐
    │  │ Chunk 1 NER 결과:                          │
    │  │ - "Rome" → location                        │
    │  │ - "Romulus" → person                       │
    │  │ - "Remus" → person                         │
    │  │ - "753 BCE" → time                         │
    │  └────────────────────────────────────────────┘
    │
    ▼
[STEP 4] 엔티티 매칭 (DB 조회)
    │
    │  "Rome" → locations.id = 2 (기존)
    │  "Romulus" → persons.id = ? (새로 생성)
    │  "Remus" → persons.id = ? (새로 생성)
    │
    ▼
[STEP 5] TextMention 저장
    │
    │  ┌────────────────────────────────────────────┐
    │  │ TextMention {                              │
    │  │   text_source_id: 1,                       │
    │  │   entity_type: "person",                   │
    │  │   entity_id: 6 (Romulus),                  │
    │  │   quote: "Romulus, the founder of Rome..." │
    │  │   confidence: 0.92                         │
    │  │ }                                          │
    │  └────────────────────────────────────────────┘
    │
    ▼
[STEP 6] 이벤트 추출 (LLM)
    │
    │  ┌────────────────────────────────────────────┐
    │  │ 추출된 이벤트:                              │
    │  │ - "로마 건국" (date: -753)                  │
    │  │ - "로물루스의 사비니 여인 납치" (date: -750) │
    │  │ - "레무스 살해" (date: -753)                │
    │  └────────────────────────────────────────────┘
    │
    ▼
[STEP 7] 이벤트-엔티티 연결
    │
    │  EventPerson: event_id=10 ↔ person_id=6 (Romulus)
    │  EventLocation: event_id=10 ↔ location_id=2 (Rome)
    │
    ▼
[STEP 8] 체인 무효화 (선택적)
    │
    │  - "로마의 역사" 체인 → visibility를 'stale'로 변경
    │  - 다음 조회 시 재생성
    │
    ▼
[완료] 새 데이터 검색 및 체인 생성 가능
```

### 2.2 처리 시간 예상

| 단계 | 소요 시간 | 비용 |
|------|----------|------|
| 텍스트 입력 | 즉시 | 무료 |
| 청킹 (책 1권) | ~1초 | 무료 |
| NER 추출 (100 청크) | ~30분 (Ollama) | 무료 |
| 엔티티 매칭 | ~10초 | 무료 |
| TextMention 저장 | ~5초 | 무료 |
| 이벤트 추출 | ~1시간 (Ollama) | 무료 |
| **총계 (책 1권)** | **~1.5시간** | **무료** |

OpenAI 사용 시: ~5분, ~$0.50

---

## 3. 기존 내용과 충돌 시 처리

### 3.1 충돌 유형

```
┌─────────────────────────────────────────────────────────────────────────┐
│                         충돌 유형 분류                                   │
└─────────────────────────────────────────────────────────────────────────┘

[유형 1] 사실 충돌 (Factual Conflict)
─────────────────────────────────────
기존: 소크라테스 사망 = -399년
신규: 소크라테스 사망 = -400년

→ 해결: 출처 신뢰도 비교 + 다수결 + 학술적 컨센서스 우선


[유형 2] 해석 충돌 (Interpretation Conflict)
─────────────────────────────────────────────
기존: "로마 멸망의 주원인은 경제적 쇠퇴"
신규: "로마 멸망의 주원인은 게르만족 침입"

→ 해결: 둘 다 저장, 사용자에게 복수 관점 제시


[유형 3] 명칭 충돌 (Naming Conflict)
────────────────────────────────────
기존: "Socrates" (영문)
신규: "苏格拉底" (중문)

→ 해결: 별칭(alias) 테이블에 추가, 동일 entity_id로 연결


[유형 4] 중복 엔티티 (Duplicate Entity)
───────────────────────────────────────
기존: Person(id=1, name="Socrates", birth=-470)
신규: Person(id=?, name="Sokrates", birth=-469)

→ 해결: 임베딩 유사도로 감지 → 병합 제안 → 관리자 승인
```

### 3.2 충돌 해결 프로세스

```
┌─────────────────────────────────────────────────────────────────────────┐
│                     충돌 해결 워크플로우                                 │
└─────────────────────────────────────────────────────────────────────────┘

                    새 정보 입력
                         │
                         ▼
              ┌─────────────────────┐
              │ 기존 데이터와 비교   │
              │ (임베딩 유사도)      │
              └──────────┬──────────┘
                         │
           ┌─────────────┼─────────────┐
           │             │             │
           ▼             ▼             ▼
    [유사도 < 0.7]  [0.7~0.95]   [유사도 > 0.95]
    "새 엔티티"     "충돌 감지"   "동일 엔티티"
           │             │             │
           ▼             ▼             ▼
    ┌──────────┐  ┌──────────────┐  ┌──────────┐
    │ 새로     │  │ 충돌 큐에    │  │ 기존     │
    │ 생성     │  │ 추가         │  │ 데이터에 │
    │          │  │ (관리자 검토)│  │ 출처 추가│
    └──────────┘  └──────┬───────┘  └──────────┘
                         │
                         ▼
              ┌─────────────────────┐
              │  관리자 검토 화면   │
              ├─────────────────────┤
              │ 기존: Socrates      │
              │       birth: -470   │
              │       source: Plato │
              │                     │
              │ 신규: Sokrates      │
              │       birth: -469   │
              │       source: Livy  │
              │                     │
              │ [병합] [별도유지]   │
              │ [신규우선] [기존우선]│
              └─────────────────────┘
```

### 3.3 다중 출처 관리

```python
# 데이터 모델
class EntityFact:
    """하나의 사실에 대한 복수 출처 관리"""
    entity_type: str      # "person", "event", etc.
    entity_id: int
    fact_type: str        # "birth_year", "death_cause", etc.
    fact_value: str       # "-399"
    sources: List[Source] # 이 사실을 뒷받침하는 출처들
    confidence: float     # 출처 개수/신뢰도 기반 계산

# 예시
{
    "entity_type": "person",
    "entity_id": 1,  # Socrates
    "fact_type": "death_year",
    "fact_value": "-399",
    "sources": [
        {"name": "Plato's Apology", "confidence": 0.95},
        {"name": "Xenophon's Memorabilia", "confidence": 0.90},
        {"name": "Diogenes Laertius", "confidence": 0.85}
    ],
    "confidence": 0.93  # 가중 평균
}
```

### 3.4 사용자에게 보여주는 방식

```
┌─────────────────────────────────────────────────────────────────────────┐
│ 소크라테스의 죽음                                                        │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│ 📅 시기: 기원전 399년 (확실도: 93%)                                      │
│                                                                         │
│ 📖 출처:                                                                │
│    • 플라톤 '소크라테스의 변명' ⭐⭐⭐⭐⭐                                │
│    • 크세노폰 '회상록' ⭐⭐⭐⭐                                           │
│    • 디오게네스 라에르티오스 ⭐⭐⭐                                       │
│                                                                         │
│ ⚠️ 이견:                                                                │
│    일부 학자들은 -400년 또는 -398년을 주장하기도 합니다.                  │
│    [상세 보기]                                                          │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 4. 초기 부트스트랩 계획

### 4.1 단계별 접근

```
┌─────────────────────────────────────────────────────────────────────────┐
│                     부트스트랩 로드맵                                    │
└─────────────────────────────────────────────────────────────────────────┘

[Phase 0] 뼈대 구축 (현재) ────────────────────────────────────────────────
│
│  목표: PoC 완성, 파이프라인 검증
│  데이터: 샘플 5명 인물, 5개 이벤트
│  소요: 완료
│
▼
[Phase 1] 시대별 핵심 시드 ─────────────────────────────────────────────────
│
│  목표: 각 시대별 "앵커" 데이터 수동 입력
│
│  ┌─────────────────────────────────────────────────────────────────┐
│  │ 시대           │ 인물 (10-20명)    │ 이벤트 (20-30개)          │
│  ├─────────────────────────────────────────────────────────────────┤
│  │ 고대 그리스    │ 소크라테스, 플라톤,│ 마라톤, 펠로폰네소스,     │
│  │ (-500~-300)   │ 아리스토텔레스... │ 알렉산더 원정...          │
│  ├─────────────────────────────────────────────────────────────────┤
│  │ 로마          │ 카이사르, 아우구스투스,│ 포에니 전쟁, 제정 수립,  │
│  │ (-500~500)    │ 네로, 콘스탄티누스 │ 서로마 멸망...            │
│  ├─────────────────────────────────────────────────────────────────┤
│  │ 중세          │ 샤를마뉴, 윌리엄1세│ 십자군, 흑사병,           │
│  │ (500~1500)    │ 잔다르크...       │ 콘스탄티노플 함락...       │
│  ├─────────────────────────────────────────────────────────────────┤
│  │ 르네상스      │ 다빈치, 미켈란젤로,│ 구텐베르크, 신대륙 발견,  │
│  │ (1400~1600)   │ 마키아벨리...     │ 종교개혁...               │
│  ├─────────────────────────────────────────────────────────────────┤
│  │ 근대          │ 뉴턴, 나폴레옹,   │ 산업혁명, 프랑스혁명,     │
│  │ (1600~1900)   │ 다윈...          │ 미국독립...               │
│  ├─────────────────────────────────────────────────────────────────┤
│  │ 현대          │ 아인슈타인, 처칠, │ 1차대전, 2차대전,         │
│  │ (1900~현재)   │ 간디...          │ 냉전, 인터넷...           │
│  └─────────────────────────────────────────────────────────────────┘
│
│  방법: Wikidata/DBpedia에서 구조화된 데이터 추출
│  소요: 1-2주 (반자동)
│  결과: ~100명 인물, ~200개 이벤트, ~50개 장소
│
▼
[Phase 2] 텍스트 소스 확장 ─────────────────────────────────────────────────
│
│  목표: 공개 도메인 텍스트에서 자동 추출
│
│  ┌─────────────────────────────────────────────────────────────────┐
│  │ 소스          │ 예상 규모     │ 우선순위  │ 처리 시간          │
│  ├─────────────────────────────────────────────────────────────────┤
│  │ Gutenberg     │ 500권 선별    │ 높음      │ ~1주 (Ollama)      │
│  │ (서양 고전)   │               │           │                    │
│  ├─────────────────────────────────────────────────────────────────┤
│  │ CText         │ 100권 선별    │ 중간      │ ~3일               │
│  │ (중국 고전)   │               │           │                    │
│  ├─────────────────────────────────────────────────────────────────┤
│  │ Perseus       │ 50권 선별     │ 높음      │ ~2일               │
│  │ (그리스/로마) │               │           │                    │
│  └─────────────────────────────────────────────────────────────────┘
│
│  방법: 자동 NER + LLM 검증 파이프라인
│  소요: 2-4주 (배치 처리)
│  결과: ~5000개 TextMention, ~1000개 추가 이벤트
│
▼
[Phase 3] 체인 사전 생성 ───────────────────────────────────────────────────
│
│  목표: 주요 인물/장소/시대의 체인을 미리 생성
│
│  우선순위:
│  1. 가장 중요한 인물 50명 → person_story 생성
│  2. 주요 도시 20개 → place_story 생성
│  3. 6개 시대 → era_story 생성
│  4. 핵심 인과관계 10개 → causal_chain 생성
│
│  방법: 배치 생성 + visibility='system' 설정
│  소요: 1-2주 (Ollama 배치)
│  결과: ~100개 사전 생성 체인
│
▼
[Phase 4] 피드백 루프 ─────────────────────────────────────────────────────
│
│  목표: 사용자 피드백으로 데이터 품질 개선
│
│  ┌─────────────────────────────────────────────────────────────────┐
│  │ 피드백 유형        │ 처리 방식                                  │
│  ├─────────────────────────────────────────────────────────────────┤
│  │ "정보가 틀렸어요" │ 오류 큐에 추가 → 관리자 검토               │
│  │ "더 알고 싶어요"  │ 해당 체인 우선순위 상승                    │
│  │ "이 인물 추가해주세요"│ 요청 큐에 추가 → 다음 배치에 포함       │
│  │ "출처가 의심스러워요"│ 해당 출처 신뢰도 재검토                 │
│  └─────────────────────────────────────────────────────────────────┘
│
▼
[지속] 점진적 확장 ────────────────────────────────────────────────────────

  - 새 책 추가 요청 처리
  - 사용자 요청 기반 우선순위 조정
  - 주기적 품질 검증 (LLM 기반)
```

### 4.2 Phase 1 상세: 시드 데이터 수집

```
┌─────────────────────────────────────────────────────────────────────────┐
│                     시드 데이터 수집 방법                                │
└─────────────────────────────────────────────────────────────────────────┘

[방법 A] Wikidata SPARQL 쿼리
──────────────────────────────
SELECT ?person ?personLabel ?birthYear ?deathYear ?occupation
WHERE {
  ?person wdt:P31 wd:Q5 .              # 인간
  ?person wdt:P106 wd:Q4964182 .       # 철학자
  ?person wdt:P569 ?birthDate .
  BIND(YEAR(?birthDate) AS ?birthYear)
  FILTER(?birthYear > -600 && ?birthYear < -300)
  SERVICE wikibase:label { bd:serviceParam wikibase:language "en,ko" }
}
LIMIT 100

→ 결과: 구조화된 JSON으로 인물/이벤트/장소 추출


[방법 B] Wikipedia 주요 문서 파싱
─────────────────────────────────
대상 페이지:
- "List of philosophers"
- "Timeline of ancient history"
- "List of wars"

→ 결과: 이름, 날짜, 관계 추출


[방법 C] 기존 역사 DB 활용
─────────────────────────────
- DBpedia (Wikipedia 구조화 버전)
- YAGO (학술 지식그래프)
- Pantheon (역사 인물 데이터)

→ 결과: 이미 정제된 데이터 임포트


[방법 D] LLM 생성 + 검증
─────────────────────────────
프롬프트: "고대 그리스 철학자 10명과 주요 사건을 JSON으로"

→ 결과: 빠른 초안 생성 후 Wikipedia로 검증
```

### 4.3 비용 및 시간 예상

```
┌─────────────────────────────────────────────────────────────────────────┐
│                     부트스트랩 비용 산정                                 │
└─────────────────────────────────────────────────────────────────────────┘

[Phase 1: 시드 데이터]
├── Wikidata 쿼리: 무료
├── 수동 정제: 시간 (10-20시간)
└── 소계: $0 (시간만 소요)

[Phase 2: 텍스트 처리 - Ollama 사용]
├── Gutenberg 500권 × 100청크 × 30초 = ~400시간 ≈ 17일
├── 전기 요금: ~$5
└── 소계: ~$5

[Phase 2: 텍스트 처리 - OpenAI 사용 시]
├── Gutenberg 500권 × 100청크 × $0.001 = ~$50
├── 처리 시간: ~8시간
└── 소계: ~$50

[Phase 3: 체인 사전 생성 - Ollama]
├── 100 체인 × 5세그먼트 × 90초 = ~12시간
└── 소계: ~$1 (전기)

[Phase 3: 체인 사전 생성 - OpenAI 시]
├── 100 체인 × 5세그먼트 × $0.002 = ~$1
└── 소계: ~$1

────────────────────────────────────────────
총 예상 비용:
- Ollama 전용: ~$6 + 시간 (~3주)
- OpenAI 병행: ~$50 + 시간 (~1주)
────────────────────────────────────────────
```

### 4.4 MVP 목표

```
┌─────────────────────────────────────────────────────────────────────────┐
│                     MVP 완료 기준                                        │
└─────────────────────────────────────────────────────────────────────────┘

✅ 데이터
   □ 인물: 100명 이상 (각 시대별 최소 10명)
   □ 이벤트: 500개 이상 (중요도 7 이상)
   □ 장소: 50개 이상 (주요 역사 도시)
   □ 시대: 10개 이상 (계층 구조 포함)

✅ 기능
   □ 4가지 체인 타입 모두 동작
   □ 검색 가능 (이름, 시대, 장소)
   □ 지구본 시각화 연동
   □ 타임라인 연동

✅ 품질
   □ 체인 생성 시간: 5분 이내
   □ 사실 정확도: 90% 이상
   □ 출처 커버리지: 80% 이상
```

---

## 요약

| 질문 | 답변 |
|------|------|
| **1. 완성 시 경험** | 자연어로 질문하면 연결된 역사 이야기를 출처와 함께 제공 |
| **2. 새 책 추가** | NER → 엔티티 매칭 → 연결 저장 → 체인 무효화 (자동) |
| **3. 충돌 처리** | 임베딩 유사도로 감지 → 관리자 검토 → 복수 출처 병행 저장 |
| **4. 초기 단계** | Phase 1(시드) → Phase 2(텍스트) → Phase 3(체인) → Phase 4(피드백) |
